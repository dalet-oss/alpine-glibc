name: 'Compile glibc'

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - .github/workflows/compile-glibc.yml
      - glibc-versions.yml
      - glibc/*.tar.gz

concurrency:
  group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
  cancel-in-progress: false


jobs:

  find-uncompiled-version:
    runs-on: ubuntu-latest
    outputs:
      compile_required: ${{ steps.parse.outputs.compile_required }}
    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - id: parse
        name: Parse glibc-versions.yml
        run: |
          VERSIONS=$(cat glibc-versions.yml | yq '.versions[].glibcVersion')
          for VERSION in ${VERSIONS[@]}; do \
            FILENAME="./glibc/glibc-bin-${VERSION}-x86_64.tar.gz"; \
            if [ -f "${FILENAME}" ]; then \
              echo "Version ${VERSION} already exists in ${FILENAME}"; \
            else \
              echo "Version ${VERSION} has not been compiled yet" && \
              echo "compile_required=${VERSION}" >${GITHUB_OUTPUT} && break; \
            fi; \
          done


  compile-glibc:
    needs: find-uncompiled-version
    if: needs.find-uncompiled-version.outputs.compile_required != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      VERSION: ${{ needs.find-uncompiled-version.outputs.compile_required }}
      FILENAME: glibc/glibc-bin-${{ needs.find-uncompiled-version.outputs.compile_required }}-x86_64.tar.gz
    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure output directory is present
        run: |
          mkdir -p glibc

      - name: Compile glibc
        run: |
          docker run --rm --env STDOUT=1 sgerrand/glibc-builder ${VERSION} /usr/glibc-compat > ${FILENAME}

      - name: Show output file, determine checksum; update checksum in glibc-versions.yml
        run: |
          ls -l ${FILENAME}
          SHA512=$(sha512sum ${FILENAME} | awk '{ print $1 }')
          echo "sha512sum for ${FILENAME} is ${SHA512}"
          yq e '(.versions[] | select(.glibcVersion == "'"$VERSION"'") | .sha512sum) = "'"$SHA512"'"' -i glibc-versions.yml

      - name: Submit new glibc tarball & its checksum via PR
        uses: peter-evans/create-pull-request@v6
        with:
          title: "Add glibc bin for ${{ env.VERSION }}, compiled by Github Actions"
          branch: "autogenerated-glibc-bin-${{ env.VERSION }}"
          body: |
            Automated PR to add the binary artifact for glibc version ${{ env.VERSION }}.
          labels: automated
          add-paths: |
            glibc/glibc-bin-${VERSION}-x64_64.tar.gz
            glibc-versions.yml
          commit-message: "Add glibc bin for ${{ env.VERSION }}, compiled by Github Actions"


  check-glibc-checksums:
    needs: find-uncompiled-version
    if: needs.find-uncompiled-version.outputs.compile_required == ''
    runs-on: ubuntu-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Check glibc checksums
        run: |
          VERSIONS=$(cat glibc-versions.yml | yq '.versions[].glibcVersion')
          for VERSION in ${VERSIONS[@]}; do \
            SHA512=$(cat glibc-versions.yml | yq '(.versions[] | select(.glibcVersion == "'"${VERSION}"'") | .sha512sum)'); \
            FILENAME="./glibc/glibc-bin-${VERSION}-x86_64.tar.gz"; \
            if [ -f "${FILENAME}" ]; then \
              echo "Version ${VERSION} exists in ${FILENAME}; validating checksum '${SHA512}'..." && \
              echo "${SHA512}  ${FILENAME}" | sha512sum --check; \
            else \
              echo "Version ${VERSION} is MISSING - this is unexpected" && false; \
            fi; \
          done
